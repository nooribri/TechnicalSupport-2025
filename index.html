<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الدخول | تطبيق الدعم الفني</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      font-family:'Cairo',sans-serif;
      margin:0;
      background:linear-gradient(to bottom right,#e5eaee,#218cc2);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    header{
      width:100%;
      padding-top:25px;
      position:relative;
      text-align:center;
    }

    .right-text{
      position:absolute;
      right:25px;
      top:15px;
      text-align:right;
      color:#000;
    }
    .right-text h2,.right-text h3,.right-text h4{
      margin:0;
      font-weight:600;
    }

    .logo-container{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .logo{ width:130px; height:auto; display:block; }

    .center-title{
      text-align:center;
      margin-top:10px;
      color:#fff;
    }
    .center-title h1{
      font-size:2rem;
      margin:10px 0 0;
      font-weight:700;
    }
    .center-title h2{
      margin:5px 0;
      opacity:.9;
      font-size:1.2rem;
      font-weight:600;
    }

    .container{
      flex:1;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }

    .login-box,.menu-area{
      background:rgba(255,255,255,.12);
      padding:35px 45px;
      border-radius:15px;
      backdrop-filter:blur(8px);
      text-align:center;
      box-shadow:0 4px 20px rgba(0,0,0,.25);
      color:#fff;
      max-width:420px;
      width:100%;
    }

    .login-box h2{ font-size:1.2rem; margin:0 0 20px; }

    .login-box input{
      width:230px;
      max-width:100%;
      padding:10px;
      border-radius:8px;
      border:none;
      text-align:center;
      outline:none;
      margin-bottom:15px;
    }

    .login-box button{
      background:#fff;
      color:#1d6f9a;           /* ✅ واضح */
      border:none;
      padding:10px 20px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      transition:.2s;
    }
    .login-box button:hover{ background:#f2f2f2; }

    .menu-icons{
      margin-top:18px;
      display:flex;
      gap:14px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .icon-box{
      width:160px;
      text-decoration:none;
      color:#fff;
      background:rgba(0,0,0,.12);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      transition:.2s;
    }
    .icon-box:hover{ transform:translateY(-2px); background:rgba(0,0,0,.18); }
    .icon-box img{
      width:85px;
      height:85px;
      border-radius:12px;
      object-fit:cover;
    }
    footer{
      margin:14px 0 18px;
      font-size:14px;
      opacity:.9;
      color:#fff;
    }
  </style>
</head>

<body>

  <header>
    <div class="right-text">
      <h2>سلطنة عمان</h2>
      <h3>هيئة حماية المستهلك</h3>
      <h4>إدارة حماية المستهلك بمحافظة الظاهرة</h4>
    </div>

    <div class="logo-container">
      <img src="image2.png" alt="شعار سلطنة عمان" class="logo">
    </div>
  </header>

  <div class="center-title">
    <h1>تطبيق الدعم الفني</h1>
    <h2>قسم تقنية المعلومات</h2>
  </div>

 <div class="container">

 <div class="login-box" id="loginBox">
  <h2>الرجاء إدخال الرقم الوظيفي</h2>

  <form id="loginForm" autocomplete="off">
    <!-- اسم مختلف حتى لا يتعرف عليه المتصفح -->
    <input
      type="text"
      id="empID"
      name="emp_code"
      placeholder="الرقم الوظيفي"
      inputmode="numeric"
      autocomplete="off"
      autocapitalize="off"
      autocorrect="off"
      spellcheck="false"
    >
  </form>

  <br>
  <button type="button" id="loginBtn">دخول</button>

  <div id="errorBox"
    style="display:none; margin-top:10px; padding:10px; border-radius:10px; background:#ffd9d9; color:#7a1d1d; font-weight:700; text-align:center;">
  </div>
</div>

  <!-- ✅ القائمة بعد الدخول -->
  <div class="menu-area" id="menuArea" style="display:none;">
    <h2>مرحباً بك، <span id="empName"></span></h2>

    <div class="menu-icons">
      <a href="support.html" class="icon-box">
        <img src="https://media.istockphoto.com/id/687438276/vector/support-service-professional-guarantee-maintenance-concept-flat-3d-web-isometric-infographic.jpg?s=612x612&w=is&k=20&c=NgHTdcuLDWxrH9dEnZJVeT1-GTwuNvkW0yOe79qAO-g=" alt="الدعم الفني">
        <span>الدعم الفني</span>
      </a>

      <a href="report1.html" class="icon-box">
        <img src="https://images.icon-icons.com/46/PNG/96/korganizer_task_tasks_list_9500.png" alt="تقرير الدعم الفني">
        <span>تقرير الدعم الفني</span>
      </a>
    </div>

    <br>
    <button type="button" onclick="logout()"
      style="background:rgba(0,0,0,.18); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer;">
      تسجيل خروج
    </button>
  </div>

</div>

<footer>
  &copy; 2025 قسم تقنية المعلومات – جميع الحقوق محفوظة
</footer>


 <script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwSXbdRX36R9Hkgda4Qw2S8As6R9Rsy6RqVKWSSEYFtvv-JkbGJabhruXoufkRW9lmceg/exec";

  window.addEventListener("load", () => {
  // Warm-up request (silent)
  fetch(`${WEB_APP_URL}?ping=1`, { cache: "no-store" }).catch(() => {});
});


  function showError(msg){
    const box = document.getElementById('errorBox');
    box.textContent = msg;
    box.style.display = "block";
  }

  function clearError(){
    const box = document.getElementById('errorBox');
    if(box){
      box.textContent = "";
      box.style.display = "none";
    }
  }


  async function login() {
  clearError();

  const btn = document.getElementById('loginBtn');
  const empInput = document.getElementById('empID');
  const empId = empInput.value.replace(/\s+/g,'').trim();

  if (!empId) return showError("رجاءً أدخل الرقم الوظيفي.");

  const originalText = btn.textContent;

  // دخول فوري (Optimistic UI)
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('menuArea').style.display = 'block';
  document.getElementById('empName').textContent = "جاري التحقق...";

  btn.disabled = true;
  btn.style.opacity = "0.7";
  btn.textContent = "جاري التحقق...";

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 12000); // 12 ثانية

  try {
    const url = `${WEB_APP_URL}?empId=${encodeURIComponent(empId)}`;
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();

    if (data.ok) {
      sessionStorage.setItem('authenticated', 'true');
      sessionStorage.setItem('employeeName', data.empName);
      document.getElementById('empName').textContent = data.empName;
      empInput.value = '';
    } else {
      // رجّع شاشة الدخول إذا غير مصرح
      document.getElementById('menuArea').style.display = 'none';
      document.getElementById('loginBox').style.display = 'block';
      showError("غير مصرح لك بالدخول. تأكد من الرقم الوظيفي.");
    }
  } catch (err) {
    // رجّع شاشة الدخول إذا فشل الاتصال
    document.getElementById('menuArea').style.display = 'none';
    document.getElementById('loginBox').style.display = 'block';
    showError("تعذر الاتصال بالنظام. تأكد من رابط الـ Web App أو الإنترنت.");
    console.error(err);
  } finally {
    clearTimeout(timeout);
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.textContent = originalText;
  }
}


  function logout(){

    
    sessionStorage.removeItem('authenticated');
    sessionStorage.removeItem('employeeId');
    sessionStorage.removeItem('employeeName');

    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('menuArea').style.display = 'none';
    document.getElementById('empName').textContent = '';

    document.getElementById('empID').value = '';
    document.getElementById('empID').focus();
    clearError();
    if(!confirm("هل أنت متأكد من تسجيل الخروج؟")) return;
  }

 window.addEventListener('load', () => {
  const ok   = sessionStorage.getItem('authenticated') === 'true';
  const name = sessionStorage.getItem('employeeName') || '';
 
 
  document.getElementById("loginBox").style.display = ok ? "none" : "block";
  document.getElementById("menuArea").style.display = ok ? "block" : "none";
  document.getElementById("empName").textContent = ok ? name : '';
  // ما عد نعرض (الاسم + الرقم) هنا

  const empInput = document.getElementById('empID');
  const btn = document.getElementById('loginBtn');

  btn.addEventListener('click', login);

  empInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      login();
    }
  });

  empInput.addEventListener('input', clearError);

  if(!ok) empInput.focus();
});

 // (اختياري) منع كليك يمين + اختصارات
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', function (e) {
    if (e.key === 'F12') e.preventDefault();
    if (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase())) e.preventDefault();
    if (e.ctrlKey && e.key.toUpperCase() === 'U') e.preventDefault();
  });
 
 
   document.getElementById('year').textContent = new Date().getFullYear();

</script>
</body>
</html>